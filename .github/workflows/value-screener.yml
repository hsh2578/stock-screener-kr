# =============================================================================
# ì €í‰ê°€ ìš°ëŸ‰ì£¼ ìŠ¤í¬ë¦¬ë„ˆ (TTM) - ì£¼ê°„ ìë™ ì—…ë°ì´íŠ¸
# Last updated: 2026-01-29
# =============================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ”:
#   1. ë§¤ì£¼ í† ìš”ì¼ 12:00 KSTì— ì €í‰ê°€ ìš°ëŸ‰ì£¼ ë°ì´í„°ë¥¼ ìˆ˜ì§‘ (TTM ê¸°ë°˜)
#   2. ìˆ˜ì§‘ì— ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ë¯€ë¡œ ì£¼ 1íšŒ ì‹¤í–‰
#
# =============================================================================

name: Weekly Value Stock Screener (TTM)

on:
  # ë§¤ì£¼ í† ìš”ì¼ 12:00 KST (UTC 03:00)
  schedule:
    - cron: '0 3 * * 6'  # Saturday 12:00 KST

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

# ê¶Œí•œ ì„¤ì •
permissions:
  contents: write

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: 'value-screener'
  cancel-in-progress: false

env:
  TZ: Asia/Seoul
  PYTHON_VERSION: '3.10'

jobs:
  collect-value-stocks:
    name: ğŸ“Š ì €í‰ê°€ ìš°ëŸ‰ì£¼ ë°ì´í„° ìˆ˜ì§‘ (TTM)
    runs-on: ubuntu-latest
    timeout-minutes: 60  # ìµœëŒ€ 60ë¶„ (í¬ë¡¤ë§ ì‹œê°„ ê³ ë ¤)

    steps:
      - name: ğŸ“¥ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          mkdir -p data

      - name: ğŸš€ ì €í‰ê°€ ìš°ëŸ‰ì£¼ ìŠ¤í¬ë¦¬ë„ˆ ì‹¤í–‰ (TTM)
        run: |
          echo "=========================================="
          echo "ì €í‰ê°€ ìš°ëŸ‰ì£¼ ìŠ¤í¬ë¦¬ë„ˆ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "=========================================="
          python test_value_screener.py
          echo "=========================================="
          echo "ìŠ¤í¬ë¦¬ë„ˆ ì‹¤í–‰ ì™„ë£Œ"
          echo "=========================================="

      - name: ğŸ” ë³€ê²½ ì‚¬í•­ í™•ì¸
        id: check_changes
        run: |
          git add data/
          if git diff --staged --quiet; then
            echo "ë³€ê²½ëœ íŒŒì¼ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ë³€ê²½ëœ íŒŒì¼:"
            git diff --staged --name-only
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          COMMIT_DATE=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M')
          git commit -m "ğŸ“ˆ ì €í‰ê°€ ìš°ëŸ‰ì£¼ ë°ì´í„° ì—…ë°ì´íŠ¸ (TTM): ${COMMIT_DATE}"
          git push

      - name: ğŸ“‹ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ“ data í´ë” íŒŒì¼:"
          ls -lh data/ 2>/dev/null || echo "  (íŒŒì¼ ì—†ìŒ)"
          echo ""
          if [ -f "data/value_stocks.json" ]; then
            echo "ğŸ“Š ì €í‰ê°€ ìš°ëŸ‰ì£¼ ê²°ê³¼:"
            python -c "import json; d=json.load(open('data/value_stocks.json')); print(f\"  ì´ {d['meta']['total_count']}ê°œ ì¢…ëª©\")"
          fi
          echo "=========================================="
