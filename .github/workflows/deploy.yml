# =============================================================================
# êµ­ë‚´ ì£¼ì‹ ìŠ¤í¬ë¦¬ë„ˆ - ë°ì´í„° ì—…ë°ì´íŠ¸ ë° GitHub Pages ìë™ ë°°í¬
# Last updated: 2026-01-29 (ìŠ¤ì¼€ì¤„ ì—…ë°ì´íŠ¸: ë§¤ì¼ 12:00, 14:00, 16:00, 18:00)
# =============================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ”:
#   1. ë§¤ì¼ 12:00, 14:00, 16:00, 18:00 KSTì— ì£¼ì‹ ë°ì´í„°ë¥¼ ìˆ˜ì§‘
#   2. ìŠ¤í¬ë¦¬ë„ˆë¥¼ ì‹¤í–‰í•˜ì—¬ JSON ë°ì´í„° ìƒì„±
#   3. GitHub Pagesì— HTML + JSON íŒŒì¼ ìë™ ë°°í¬
#
# =============================================================================

name: Daily Data Update & Deploy

on:
  # ë§¤ì¼ 12:00, 14:00, 16:00, 18:00 KST
  schedule:
    - cron: '0 3 * * *'   # 12:00 KST
    - cron: '0 5 * * *'   # 14:00 KST
    - cron: '0 7 * * *'   # 16:00 KST
    - cron: '0 9 * * *'   # 18:00 KST

  # main ë¸Œëœì¹˜ì— í‘¸ì‹œ ì‹œ ë°°í¬
  push:
    branches: [main]
    paths:
      - 'ì£¼ì‹_ìŠ¤í¬ë¦¬ë„ˆ_ì „ì²´.html'
      - 'run_screeners.py'
      - 'scripts/**'
      - 'data/**'
      - '.github/workflows/deploy.yml'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      skip_data_collection:
        description: 'ë°ì´í„° ìˆ˜ì§‘ ê±´ë„ˆë›°ê¸° (ë°°í¬ë§Œ)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# ê¶Œí•œ ì„¤ì •
permissions:
  contents: write
  pages: write
  id-token: write

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: 'pages-deploy'
  cancel-in-progress: false

env:
  TZ: Asia/Seoul
  PYTHON_VERSION: '3.10'

jobs:
  # =========================================================================
  # Job 1: ë°ì´í„° ìˆ˜ì§‘ (ìŠ¤ì¼€ì¤„ ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ)
  # =========================================================================
  collect-data:
    name: ğŸ“Š ë°ì´í„° ìˆ˜ì§‘
    runs-on: ubuntu-latest
    # push ì´ë²¤íŠ¸ê°€ ì•„ë‹ ë•Œë§Œ ì‹¤í–‰ (ë˜ëŠ” ìˆ˜ë™ìœ¼ë¡œ skip ì„ íƒ ì‹œ ê±´ë„ˆëœ€)
    if: github.event_name != 'push' && github.event.inputs.skip_data_collection != 'true'

    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}

    steps:
      - name: ğŸ“¥ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„±
        run: |
          mkdir -p data
          mkdir -p logs

      - name: ğŸš€ ìŠ¤í¬ë¦¬ë„ˆ ì‹¤í–‰
        run: |
          echo "=========================================="
          echo "ìŠ¤í¬ë¦¬ë„ˆ ì‹¤í–‰ ì‹œì‘: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "=========================================="
          python run_screeners.py
          echo "=========================================="
          echo "ìŠ¤í¬ë¦¬ë„ˆ ì‹¤í–‰ ì™„ë£Œ"
          echo "=========================================="

      - name: ğŸ” ë³€ê²½ ì‚¬í•­ í™•ì¸
        id: check_changes
        run: |
          git add data/ logs/
          if git diff --staged --quiet; then
            echo "ë³€ê²½ëœ íŒŒì¼ ì—†ìŒ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ë³€ê²½ëœ íŒŒì¼:"
            git diff --staged --name-only
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ’¾ ë³€ê²½ ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          COMMIT_DATE=$(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M')
          git commit -m "ğŸ“Š ë°ì´í„° ìë™ ì—…ë°ì´íŠ¸: ${COMMIT_DATE}"
          git push

      - name: ğŸ“‹ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
        if: always()
        run: |
          echo "=========================================="
          echo "ğŸ“ data í´ë” íŒŒì¼:"
          ls -lh data/ 2>/dev/null || echo "  (íŒŒì¼ ì—†ìŒ)"
          echo ""
          if [ -d "logs" ]; then
            echo "ğŸ“ ìµœê·¼ ë¡œê·¸:"
            LATEST_LOG=$(ls -t logs/*.log 2>/dev/null | head -1)
            if [ -n "$LATEST_LOG" ]; then
              tail -20 "$LATEST_LOG"
            fi
          fi
          echo "=========================================="

  # =========================================================================
  # Job 2: GitHub Pages ë°°í¬
  # =========================================================================
  deploy:
    name: ğŸš€ GitHub Pages ë°°í¬
    runs-on: ubuntu-latest
    needs: [collect-data]
    # collect-dataê°€ ì„±ê³µí•˜ê±°ë‚˜ ìŠ¤í‚µëœ ê²½ìš°, ë˜ëŠ” push ì´ë²¤íŠ¸ì¸ ê²½ìš° ì‹¤í–‰
    if: always() && (needs.collect-data.result == 'success' || needs.collect-data.result == 'skipped' || github.event_name == 'push')

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ğŸ“¥ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ (ìµœì‹  ë°ì´í„° í¬í•¨)
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ğŸ“ ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„
        run: |
          mkdir -p _site/data

          # HTML íŒŒì¼ ë³µì‚¬ (index.htmlë¡œ)
          cp ì£¼ì‹_ìŠ¤í¬ë¦¬ë„ˆ_ì „ì²´.html _site/index.html
          cp favicon.svg _site/favicon.svg

          # ë°ì´í„° íŒŒì¼ ë³µì‚¬
          if [ -d "data" ] && [ "$(ls -A data/)" ]; then
            cp -r data/* _site/data/
            echo "âœ… ë°ì´í„° íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"
            ls -la _site/data/
          else
            echo "âš ï¸ data í´ë”ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤"
          fi

          # 404.html ìƒì„± (SPA ì§€ì›)
          cat > _site/404.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>ì£¼ì‹ ìŠ¤í¬ë¦¬ë„ˆ</title>
            <script>
              // SPA ë¦¬ë‹¤ì´ë ‰íŠ¸: ëª¨ë“  ê²½ë¡œë¥¼ index.htmlë¡œ ì „ë‹¬
              sessionStorage.setItem('redirect', location.pathname);
              location.replace('/stock-screener-kr/');
            </script>
          </head>
          <body>
            <p>í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¤‘...</p>
          </body>
          </html>
          EOF

          echo "âœ… ë°°í¬ ë””ë ‰í† ë¦¬ ì¤€ë¹„ ì™„ë£Œ"
          echo "ğŸ“ _site êµ¬ì¡°:"
          find _site -type f

      - name: ğŸ“¤ Pages ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: ğŸŒ GitHub Pages ë°°í¬
        id: deployment
        uses: actions/deploy-pages@v4

      - name: âœ… ë°°í¬ ì™„ë£Œ
        run: |
          echo "=========================================="
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ!"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo "=========================================="
